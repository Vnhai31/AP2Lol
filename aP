_G.Settings = {
    ShowNames = true,
    ShowDistance = true
}

local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

-- Hàm tạo BillboardGui và Highlight
local function createESP(name)
    local billboard = Instance.new("BillboardGui")
    billboard.Size = UDim2.new(0, 200, 0, 50)
    billboard.AlwaysOnTop = true
    billboard.StudsOffset = Vector3.new(0, 3.5, 0) -- Đặt billboard phía trên đầu

    local textLabel = Instance.new("TextLabel")
    textLabel.Size = UDim2.new(1, 0, 1, 0)
    textLabel.BackgroundTransparency = 1
    textLabel.TextColor3 = Color3.new(1, 1, 1)
    textLabel.Font = Enum.Font.SourceSansBold
    textLabel.TextSize = 10
    textLabel.Text = name
    textLabel.Parent = billboard

    local highlight = Instance.new("Highlight")
    highlight.FillColor = Color3.new(0, 1, 0) -- Màu xanh lá cho phần tô
    highlight.OutlineColor = Color3.new(0, 1, 0) -- Màu viền
    highlight.FillTransparency = 0.9
    highlight.OutlineTransparency = 0.2
    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop -- Hiển thị xuyên vật thể

    return billboard, textLabel, highlight
end

-- Tạo bảng ESP cho mỗi người chơi
local billboards = {}

for _, player in ipairs(Players:GetPlayers()) do
    if player ~= LocalPlayer and player.Character then
        local humanoidRootPart = player.Character:WaitForChild("HumanoidRootPart")
        local billboard, label, highlight = createESP(player.Name)
        billboard.Adornee = humanoidRootPart
        billboard.Parent = player.Character
        highlight.Adornee = player.Character -- Highlight áp dụng cho toàn bộ nhân vật
        highlight.Parent = player.Character
        billboards[player] = { billboard = billboard, label = label, highlight = highlight }
    end
end

-- Hàm cập nhật ESP
local function updateBillboards()
    for player, data in pairs(billboards) do
        if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local humanoidRootPart = player.Character.HumanoidRootPart
            local myRoot = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
            if myRoot then
                local distance = (myRoot.Position - humanoidRootPart.Position).Magnitude
                if distance <= 3000 then
                    -- Hiển thị billboard và highlight nếu khoảng cách <= 3000 studs
                    data.billboard.Enabled = true
                    data.highlight.Enabled = true
                    local text = ""
                    if _G.Settings.ShowNames then
                        text = player.Name
                    end
                    if _G.Settings.ShowDistance then
                        text = text .. " [" .. math.floor(distance) .. " studs]"
                    end
                    data.label.Text = text
                else
                    -- Ẩn billboard và highlight nếu khoảng cách > 3000 studs
                    data.billboard.Enabled = false
                    data.highlight.Enabled = false
                end
            else
                data.billboard.Enabled = false
                data.highlight.Enabled = false
            end
        else
            data.billboard.Enabled = false
            data.highlight.Enabled = false
        end
    end
end

-- Cập nhật mỗi giây
coroutine.wrap(function()
    while true do
        updateBillboards()
        wait(0.25) -- Chờ 0.25 giây trước khi cập nhật lại
    end
end)()

-- Nếu người chơi mới vào game
Players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function(char)
        local humanoidRootPart = char:WaitForChild("HumanoidRootPart")
        local billboard, label, highlight = createESP(player.Name)
        billboard.Adornee = humanoidRootPart
        billboard.Parent = char
        highlight.Adornee = char -- Highlight áp dụng cho toàn bộ nhân vật
        highlight.Parent = char
        billboards[player] = { billboard = billboard, label = label, highlight = highlight }
    end)
end)

-- Nếu người chơi rời game
Players.PlayerRemoving:Connect(function(player)
    if billboards[player] then
        billboards[player].billboard:Destroy()
        billboards[player].highlight:Destroy()
        billboards[player] = nil
    end
end)
